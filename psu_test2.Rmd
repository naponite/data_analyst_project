---
title: "psu_test2"
author: "Napon Meenmane"
date: "2023-11-30"
output: html_document
---

## 1. Data Overview

```{r}
library(dplyr)
library(feather)
library(ggplot2)
library(skimr)
library(lubridate)

#import feather file
df_cli <- read_feather("clinic.feather", columns = NULL)
df_demo_raw <- read_feather("demographic.feather", columns = NULL)
df_diag <- read_feather("diag.feather", columns = NULL)
```


#### Table Diag (df_diag)

```{r}
#skim(df_diag)
glimpse(df_diag) %>% head()
```


#### Table Demographic (df_demo_raw)

```{r}
#skim(df_demo_raw)
glimpse(df_demo_raw) %>% head()
```


#### Table Clinic (df_cli)

```{r}
#skim(df_cli)
glimpse(df_cli) %>% head()
```


## 2. Data preparation

#### Data cleansing
```{r}
df_demo <- df_demo_raw %>%  
  filter(bdate != "0000-00-00" & bdate != "NULL") 
```

#### Data preparation
กำหนดเกณฑ์การคัดกรองกลุ่มผู้ป่วยที่ต้องการติดตาม คือ
-	ได้รับการวินิจฉัยโรคเบาหวาน (ICD-10 : E11 - E14)
-	อายุระหว่าง 15 - 75 ปี 
-	เข้ารับบริการในคลินิกอายุรกรรมทั้งหมด
-	เข้ารับบริการในช่วงปีงบประมาณ 2565 (1 ต.ค. 2564 - 30 ก.ย. 2565)
-	ไม่เคยมีประวัติวินิจฉัยโรคความดันโลหิตมาก่อน (ICD-10 : I10)

```{r}
df <- df_diag %>%
  left_join(df_demo, by = "id") %>%
  left_join(df_cli, by = c("code_cl" = "c_unit")) %>%
  filter(grepl("^E1[1-4].",df_diag$icd10)) %>%
  filter(grepl("อายุร",dep_name)) %>%
  filter(between(date_cl,ymd("2021-10-01"),ymd("2022-09-30"))) %>%
  mutate(age = as.numeric(today()-ymd(bdate))/365) %>%
  filter(between(age,15,75)) %>%
  mutate(sex = if_else(sex == 1, "male", "female"))

df_i10 <- df_diag %>%
  mutate(i10 = if_else(icd10 == "I10", "yes","no")) %>%
  filter(i10 == "yes") %>%
  select(id,i10)

df_final <- df %>%
  left_join(df_i10, by = "id") %>%
  mutate(i10 = if_else(is.na(i10), "no", "yes")) %>%
  filter(i10 == "no") %>%
  select(-i10) %>%
  mutate(age = round(age))


```


#### Overview Final Data (df_final)

```{r}
head(df_final)

```

## Question 1
จำนวนผู้ป่วย โดยสรุปเป็นราย ปี - เดือน คลินิก เพศ และช่วงอายุของผู้ป่วยที่เข้ารับบริการเพื่อเป็นแนวทางแก้ไขปัญหาความหนาแน่นของการเข้ารับบริการในแต่ละคลินิก และช่วงเวลา

```{r}
summary_overall <- df_final %>%
  mutate(year = year(date_cl),
         month = month(date_cl)) %>%
  select(year, month, code_cl, sex, age) %>%
  group_by(year, month, code_cl, sex) %>%
  summarise(
    min_age = min(age),
    max_age = max(age),
    n = n()
  ) %>%
  arrange(year,month,code_cl)

# Export CSV file
# write_csv(summary_overall,"psu_hospital_data.csv")

head(summary_overall)
```


## Question 2
การตรวจวินิจฉัยโรคเบาหวานส่วนใหญ่ผู้ป่วยจะได้รับการวินิจฉัยว่าเป็นเบาหวานครั้งแรกในคลินิกใด และช่วงอายุเฉลี่ยเท่าไร
```{r}
df_Q2 <- df_final %>%
  group_by(id) %>%
  mutate(first_iden_date = min(date_cl)) %>%
  filter(first_iden_date == date_cl) %>%
  group_by(code_cl, u_name) %>%
  summarize(n = n(),
            avg_age = round(mean(age)),
            min_age = min(age),
            max_age = max(age)) %>%
  arrange(desc(n))

head(df_Q2)

```



